# ========================================
# Kubernetes Homelab Sysctl Configuration
# Optimized for 3-node cluster
# ========================================

# IPv6 Configuration
net.ipv6.conf.all.disable_ipv6=0
net.ipv6.conf.default.disable_ipv6=0
net.ipv6.conf.lo.disable_ipv6=0

# ========================================
# Essential Kubernetes Requirements
# ========================================

# Inotify limits - kubelet watches many files
fs.inotify.max_user_watches = 524288
fs.inotify.max_user_instances = 512

# Connection tracking for kube-proxy/iptables
net.netfilter.nf_conntrack_max = 262144
net.netfilter.nf_conntrack_tcp_timeout_established = 86400

# Memory mapping - required for databases, Elasticsearch, etc.
vm.max_map_count = 262144

# Bridge netfilter - required for pod networking
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1

# ========================================
# File and Process Limits (Homelab Scale)
# ========================================

fs.file-max = 524288
fs.nr_open = 262144
kernel.pid_max = 131072

# ========================================
# Network Tuning (Moderate Scale)
# ========================================

# Connection queue sizes
net.core.somaxconn = 8192
net.core.netdev_max_backlog = 4096

# Socket buffer sizes
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 4194304

# ========================================
# TCP Settings
# ========================================

# SYN backlog for handling connection bursts
net.ipv4.tcp_max_syn_backlog = 2048

# TCP keepalive - detect dead connections
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 90

# TCP connection cleanup
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_max_tw_buckets = 65536
net.ipv4.tcp_tw_reuse = 1

# TCP memory tuning
net.ipv4.tcp_rmem = 4096 87380 4194304
net.ipv4.tcp_wmem = 4096 16384 4194304

# Use cubic (default) - better for low-latency local networks
net.ipv4.tcp_congestion_control = cubic

# ========================================
# CPU Scheduler
# ========================================

# Disable autogroup for better container CPU fairness
kernel.sched_autogroup_enabled = 0

# ========================================
# Security & Stability
# ========================================

# Protect against SYN flood attacks
net.ipv4.tcp_syncookies = 1

# Disable IP forwarding by default (Kubernetes will enable as needed)
net.ipv4.ip_forward = 1

# Increase ephemeral port range
net.ipv4.ip_local_port_range = 10000 65535
